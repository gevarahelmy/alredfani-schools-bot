#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒØªØ¨
"""

import logging
import sqlite3
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø±Ù…Ø² Ø§Ù„Ø¨ÙˆØª - ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø±Ù…Ø² Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
BOT_TOKEN = "7819230561:AAGeMTOjrbmVoyk9Rg66Oe9Db6QSVAxZKjk"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def init_database():
    """Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØªØ¨"""
    conn = sqlite3.connect('books.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS books (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            grade TEXT NOT NULL,
            subject TEXT NOT NULL,
            file_path TEXT NOT NULL,
            description TEXT
        )
    ''')
    
    # Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    sample_books = [
        ("ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "books/math_grade1.pdf", "ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"),
        ("ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„", "Ø¹Ù„ÙˆÙ…", "books/science_grade1.pdf", "ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ… Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"),
        ("ÙƒØªØ§Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©", "books/arabic_grade2.pdf", "ÙƒØªØ§Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ"),
        ("ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "books/math_grade2.pdf", "ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ"),
        ("ÙƒØªØ§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«", "ØªØ§Ø±ÙŠØ®", "books/history_grade3.pdf", "ÙƒØªØ§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«"),
    ]
    
    cursor.executemany('''
        INSERT OR IGNORE INTO books (title, grade, subject, file_path, description)
        VALUES (?, ?, ?, ?, ?)
    ''', sample_books)
    
    conn.commit()
    conn.close()

def search_books(query):
    """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    conn = sqlite3.connect('books.db')
    cursor = conn.cursor()
    
    # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØµÙ ÙˆØ§Ù„Ù…Ø§Ø¯Ø©
    cursor.execute('''
        SELECT * FROM books 
        WHERE title LIKE ? OR grade LIKE ? OR subject LIKE ?
        ORDER BY grade, subject, title
    ''', (f'%{query}%', f'%{query}%', f'%{query}%'))
    
    results = cursor.fetchall()
    conn.close()
    return results

def get_books_by_grade():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ù…Ø¬Ù…Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ"""
    conn = sqlite3.connect('books.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT DISTINCT grade FROM books ORDER BY grade')
    grades = [row[0] for row in cursor.fetchall()]
    
    conn.close()
    return grades

def get_books_by_grade_name(grade):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ù„ØµÙ Ù…Ø¹ÙŠÙ†"""
    conn = sqlite3.connect('books.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM books WHERE grade = ? ORDER BY subject, title', (grade,))
    results = cursor.fetchall()
    
    conn.close()
    return results

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start"""
    welcome_message = """
ğŸ‡¾ğŸ‡ª Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ALREDFANI SCHOOL SYSTEM ğŸ“š

Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§.

Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:
ğŸ“– /search <Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø§Ø¯Ø©> - Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ù…Ø¹ÙŠÙ†
ğŸ“‹ /list - Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØªØ§Ø­Ø©
â„¹ï¸ /help - Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©

Ù…Ø«Ø§Ù„ Ù„Ù„Ø¨Ø­Ø«:
/search Ø±ÙŠØ§Ø¶ÙŠØ§Øª
/search Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
/search Ø¹Ù„ÙˆÙ…

Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„ØªØ¹Ù„Ù…! ğŸ“
    """
    
    await update.message.reply_text(welcome_message)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /help"""
    await start(update, context)

async def search_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /search"""
    if not context.args:
        await update.message.reply_text(
            "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.\n"
            "Ù…Ø«Ø§Ù„: /search Ø±ÙŠØ§Ø¶ÙŠØ§Øª"
        )
        return
    
    query = ' '.join(context.args)
    books = search_books(query)
    
    if not books:
        await update.message.reply_text(
            f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØªØ¨ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ '{query}'.\n"
            "Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… /list Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©."
        )
        return
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    message = f"ğŸ“š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† '{query}':\n\n"
    keyboard = []
    
    for book in books:
        book_id, title, grade, subject, file_path, description = book
        message += f"ğŸ“– {title}\n"
        message += f"ğŸ“ {grade} - {subject}\n"
        if description:
            message += f"ğŸ“ {description}\n"
        message += "\n"
        
        # Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        keyboard.append([InlineKeyboardButton(
            f"ØªØ­Ù…ÙŠÙ„ {title}", 
            callback_data=f"download_{book_id}"
        )])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(message, reply_markup=reply_markup)

async def list_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /list"""
    grades = get_books_by_grade()
    
    if not grades:
        await update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    
    message = "ğŸ“‹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n"
    keyboard = []
    
    for grade in grades:
        keyboard.append([InlineKeyboardButton(
            f"ğŸ“š {grade}", 
            callback_data=f"grade_{grade}"
        )])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(message, reply_markup=reply_markup)

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¶Ù…Ù†Ø©"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data.startswith("download_"):
        # ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ø¨
        book_id = int(data.split("_")[1])
        
        conn = sqlite3.connect('books.db')
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM books WHERE id = ?', (book_id,))
        book = cursor.fetchone()
        conn.close()
        
        if book:
            book_id, title, grade, subject, file_path, description = book
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
            if os.path.exists(file_path):
                try:
                    with open(file_path, 'rb') as file:
                        await query.message.reply_document(
                            document=file,
                            filename=f"{title}.pdf",
                            caption=f"ğŸ“– {title}\nğŸ“ {grade} - {subject}"
                        )
                except Exception as e:
                    await query.message.reply_text(
                        f"Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØªØ§Ø¨: {str(e)}"
                    )
            else:
                await query.message.reply_text(
                    "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹."
                )
        else:
            await query.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨.")
    
    elif data.startswith("grade_"):
        # Ø¹Ø±Ø¶ ÙƒØªØ¨ ØµÙ Ù…Ø¹ÙŠÙ†
        grade = data.split("grade_", 1)[1]
        books = get_books_by_grade_name(grade)
        
        if not books:
            await query.message.reply_text(f"Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…ØªØ§Ø­Ø© Ù„Ù€ {grade}.")
            return
        
        message = f"ğŸ“š ÙƒØªØ¨ {grade}:\n\n"
        keyboard = []
        
        for book in books:
            book_id, title, grade, subject, file_path, description = book
            message += f"ğŸ“– {title} - {subject}\n"
            
            keyboard.append([InlineKeyboardButton(
                f"ØªØ­Ù…ÙŠÙ„ {title}", 
                callback_data=f"download_{book_id}"
            )])
        
        # Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
        keyboard.append([InlineKeyboardButton("ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_list")])
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(message, reply_markup=reply_markup)
    
    elif data == "back_to_list":
        # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ
        grades = get_books_by_grade()
        
        message = "ğŸ“‹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n"
        keyboard = []
        
        for grade in grades:
            keyboard.append([InlineKeyboardButton(
                f"ğŸ“š {grade}", 
                callback_data=f"grade_{grade}"
            )])
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(message, reply_markup=reply_markup)

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©"""
    text = update.message.text
    
    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙŠØ¨Ø¯Ùˆ ÙƒØ¨Ø­Ø«ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø¨Ø­Ø«
    if len(text) > 2:
        books = search_books(text)
        
        if books:
            message = f"ğŸ“š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† '{text}':\n\n"
            keyboard = []
            
            for book in books[:5]:  # Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 5 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
                book_id, title, grade, subject, file_path, description = book
                message += f"ğŸ“– {title}\n"
                message += f"ğŸ“ {grade} - {subject}\n\n"
                
                keyboard.append([InlineKeyboardButton(
                    f"ØªØ­Ù…ÙŠÙ„ {title}", 
                    callback_data=f"download_{book_id}"
                )])
            
            if len(books) > 5:
                message += f"... ÙˆØ¹Ø«Ø±Øª Ø¹Ù„Ù‰ {len(books) - 5} ÙƒØªØ¨ Ø£Ø®Ø±Ù‰\n"
                message += "Ø§Ø³ØªØ®Ø¯Ù… /search Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚"
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(message, reply_markup=reply_markup)
        else:
            await update.message.reply_text(
                f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØªØ¨ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ '{text}'.\n"
                "Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… /list Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©."
            )
    else:
        await update.message.reply_text(
            "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø³ØªØ®Ø¯Ù… /search Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ø£Ùˆ /list Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©."
        )

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù…Ø² Ø§Ù„Ø¨ÙˆØª
    if BOT_TOKEN == "YOUR_BOT_TOKEN_HERE":
        print("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ BOT_TOKEN ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙˆØ¶Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ")
        return
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    init_database()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙƒØªØ¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    os.makedirs('books', exist_ok=True)
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("search", search_command))
    application.add_handler(CommandHandler("list", list_command))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    print("ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()

